<!DOCTYPE html>
<html>

<head>
  <title>SL Experiment</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>

<body></body>
<script>

  /* initialize jsPsych */
  var jsPsych = initJsPsych(
   {
     on_finish: function () {
       jsPsych.data.
       get()
        .ignore(['plugin_version', 'trial_type'])
        .localSave('csv', 'Trial.csv');;;
     }
   }
 );
    


  /* create timeline */
  var timeline = [];

  /* welcome */
  var welcome = {
   type: jsPsychHtmlKeyboardResponse,
   stimulus: "Welcome to the experiment. Press any key to begin.",
 };

  /* full screen */
 var enter_fullscreen ={
  type: jsPsychFullscreen,
  fullscreen_mode:true
 }
 timeline.push(enter_fullscreen);

 /* participant ID */
 var participant_id_entry= {
  type: jsPsychSurveyText,
  questions: [{prompt:"Please enter your participant ID (e.g. p1):", name:"participant_id"}],
  on_finish: function(data){
    console.log(data.response)
    jsPsych.data.addProperties({
      participant: data.response.participant_id
    });
  }
 };
 timeline.push(participant_id_entry);

 timeline.push(welcome);

 /* instructions*/
 var instructions = {
   type: jsPsychHtmlKeyboardResponse,
   stimulus: `
  <p>For this trial, you will see a series of images.</p>
  <p>Press the spacebar whenever you see a repeat of an image.</p>
  <p>Press any key to begin.</p>`
 };

 //add the instructions trial to the timeline
 timeline.push(instructions);

  /* create stimulus list */
  //first create a list of categories
  var category_list = ["bar", "bathroom", "bridge", "coast", "gym", "desert", "kitchen", "field", "playground", "stream", "street", "woods"]
  //shuffle
  var category_list_shuffled = jsPsych.randomization.shuffle(category_list);
  console.log(category_list_shuffled)

  //now define the roles in the triplets based on the randomized position of the items in the array (A=0, B=1, ...)
  //note that we are always selecting the first image here, but we could also randomly select from the set of images for each category here
  // define key elements of the image
  var img_extension = ".jpg"
  var img_id = "1" // could make a random selection from a constrained list of images here
  var img_path = "stimuli/"
  var stimulus_list = {
    A: { category: category_list_shuffled[0], image_name: img_path + category_list_shuffled[0] + "_" + img_id + img_extension },
    B: { category: category_list_shuffled[1], image_name: img_path + category_list_shuffled[1] + "_" + img_id + img_extension },
    C: { category: category_list_shuffled[2], image_name: img_path + category_list_shuffled[2] + "_" + img_id + img_extension },
    D: { category: category_list_shuffled[3], image_name: img_path + category_list_shuffled[3] + "_" + img_id + img_extension },
    E: { category: category_list_shuffled[4], image_name: img_path + category_list_shuffled[4] + "_" + img_id + img_extension },
    F: { category: category_list_shuffled[5], image_name: img_path + category_list_shuffled[5] + "_" + img_id + img_extension },
    G: { category: category_list_shuffled[6], image_name: img_path + category_list_shuffled[6] + "_" + img_id + img_extension },
    H: { category: category_list_shuffled[7], image_name: img_path + category_list_shuffled[7] + "_" + img_id + img_extension },
    I: { category: category_list_shuffled[8], image_name: img_path + category_list_shuffled[8] + "_" + img_id + img_extension },
    J: { category: category_list_shuffled[9], image_name: img_path + category_list_shuffled[9] + "_" + img_id + img_extension },
    K: { category: category_list_shuffled[10], image_name: img_path + category_list_shuffled[10] + "_" + img_id + img_extension },
    L: { category: category_list_shuffled[11], image_name: img_path + category_list_shuffled[11] + "_" + img_id + img_extension }
  };

  //create a "toy" trial list of 12 images
  // How can we expand this stream of images into a more general, randomized trial list?
  var toy_list = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L"]
  var randomized_list = jsPsych.randomization.shuffle(toy_list);

  var t1 =[randomized_list.slice(0,3)];
  var t2 =[randomized_list.slice(3,6)];
  var t3 =[randomized_list.slice(6,9)];
  var t4 =[randomized_list.slice(9,12)];

  var trips_list = [t1, t2, t3, t4]

  var randomize_trips = jsPsych.randomization.shuffle(trips_list);
  var trips_shuffled = randomize_trips.flat(Infinity);
  console.log(trips_shuffled)
  

  //create an array telling us when to repeat one of the images
  // how can we generalize this for the full trial list
  // can only be the first or third element in a triplet
  // from the paper: "images were inserted into the stream such that sometimes either the first or third image in a triplet repeated immediately"
  var repeat_ids = [5, 12]

  //create a trial counter to keep track of how many images we've shown so far
  // also create a running counter tracking the repeat images we've added
  var trial_counter = 0
  var repeat_counter = 0

  //create a for loop to run through the trial list
  for (i = 0; i < trips_shuffled.length; i++) {

    //store the current category letter 
    var current_letter = trips_shuffled[i];
    //store the corresponding category and image name
    var current_category = stimulus_list[current_letter]["category"];
    var current_image_name = stimulus_list[current_letter]["image_name"];

    // here's how we can construct a simple image trial
    // TO DO: what else do we need to add to the trial procedure? What other information should we store? How can we turn this into a complete experiment timeline?
    var trial = {
      type: jsPsychImageKeyboardResponse,
      stimulus: current_image_name,
      //make the space bar a response option
      choices: [" "],
      //the stimulus is shown for 300 ms
      stimulus_duration: 300,
      data: {
        category: current_category,
        letter: current_letter,
        correct_response: "non-repeat",
        correct_response_key: null,
        trial_counter: trial_counter
      },
      //post trial gap of 700ms (300+700ms = 1000ms)
      // controlling this through the overall trial duration ensures that we can collect a response before the next image starts
      trial_duration: 1000,
      //response should not end trial so that we can keep the same consistent presentation timing
      response_ends_trial: false
    }
    //push the trial to the timeline
    timeline.push(trial);

    // check if we should insert a repeat image
    // if we do, make sure to update the repeat counter 
    //so that we move on to the next repeated event when checking in future iterations
    var current_repeat_id = repeat_ids[repeat_counter];
    if (i == current_repeat_id) {
      //if we've reached a repeat trial insert an extra image
      var repeat_trial = {
        type: jsPsychImageKeyboardResponse,
        stimulus: current_image_name,
        //make the space bar a response option
        choices: [" "],
        //the stimulus is shown for 300 ms
        stimulus_duration: 300,
        data: {
          category: current_category,
          letter: current_letter,
          //now it IS a repeat!
          correct_response: "repeat",
          //space bar is the correct response
          correct_response_key: " ",
          trial_counter: trial_counter
        },
        //post trial gap of 700ms (300+700ms = 1000ms)
        // doing it this way ensures that we can collect a response before the next image starts
        trial_duration: 1000,
        //response should not end trial so that we can keep the same consistent presentation timing
        response_ends_trial: false
      }
      //push the trial to the timeline
      timeline.push(repeat_trial);

      // update the repeat counter
      repeat_counter = repeat_counter + 1;
    }
    //update the trial_counter
    trial_counter = trial_counter + 1;

  }

// Define study triplets and foil triplets
var study_triplets = [
  ['A', 'B', 'C'],
  ['D', 'E', 'F'],
  ['G', 'H', 'I'],
  ['J', 'K', 'L']
];

var foil_triplets = [
  ['A', 'E', 'I'],
  ['D', 'H', 'L'],
  ['G', 'K', 'C'],
  ['J', 'B', 'F']
];

// Helper function to create HTML for a triplet of images
function createImageTripletHTML(triplet) {
  return `
    <div style="display: flex; justify-content: center; gap: 20px;">
      <img src="${stimulus_list[triplet[0]].image_name}" width="200" height="200">
      <img src="${stimulus_list[triplet[1]].image_name}" width="200" height="200">
      <img src="${stimulus_list[triplet[2]].image_name}" width="200" height="200">
    </div>
  `;
}

// Familiarity test trials
var familiarity_test_trials = [];

study_triplets.forEach((study_triplet, index) => {
  for (let i = 0; i < 2; i++) {  // Each triplet is tested twice with each foil
    var foil_triplet = foil_triplets[index];

    // Randomize order: 0 = test triplet first, 1 = foil triplet first
    var order = Math.random() < 0.5 ? 0 : 1;

    // Define the two sequences with 1000ms pause in between
    var test_sequence_trial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: createImageTripletHTML(order === 0 ? study_triplet : foil_triplet),
      choices: "NO_KEYS",
      trial_duration: 1000,  // Display each triplet for 1000 ms
    };

    var foil_sequence_trial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: createImageTripletHTML(order === 1 ? study_triplet : foil_triplet),
      choices: "NO_KEYS",
      trial_duration: 1000,  // Display each triplet for 1000 ms
    };

    // Add a 1000ms pause between sequences
    var pause_between_sequences = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "<p></p>",
      choices: "NO_KEYS",
      trial_duration: 1000
    };

    // Collect response after both sequences have been shown
    var response_trial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "<p>Press '1' if the first sequence was familiar, '2' if the second was.</p>",
      choices: ['1', '2'],
      data: {
        test_triplet: study_triplet,
        foil_triplet: foil_triplet,
        correct_response: order === 0 ? '1' : '2'  // Correct response based on sequence order
      },
      on_finish: function(data) {
        data.correct = data.response === data.correct_response;
      }
    };

    // Add the sequence trials and response trial to the timeline
    familiarity_test_trials.push(test_sequence_trial);
    familiarity_test_trials.push(pause_between_sequences);
    familiarity_test_trials.push(foil_sequence_trial);
    familiarity_test_trials.push(response_trial);
  }
});

// Add familiarity test trials to the timeline
timeline.push(...familiarity_test_trials);

  /* start the experiment */
  jsPsych.run(timeline);

</script>

</html>